@page "/epkrs/dashboard"
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject Blazored.SessionStorage.ISyncSessionStorageService syncSessionStorage
@inject IEPKRSService EPKRSService
@inject ILoginService LoginService
@inject IManagementService ManagementService
@inject NavigationManager navigate
@inject IJSRuntime JS

<PageTitle>EPKRS - Dashboard</PageTitle>

@if (LoginService.activeUser == null)
{
    <p>Loading...</p>
}
else
{
    if (LoginService.activeUser.userPrivileges != null)
    {
        @if (!LoginService.activeUser.userPrivileges.Contains("VW"))
        {
            <div class="container-fluid">
                <div class="d-flex align-items-center">
                    <h3>User Require Elevation</h3>
                </div>
            </div>
        }
        else
        {
            <h3>EPKRS</h3>
            <small><i>EPKRS Dashboard</i></small>

            @if (alertTrigger)
            {
                <div class="alert alert-warning alert-dismissible fade show my-3" role="alert">
                    <strong>@alertMessage</strong> @alertBody
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" @onclick="(() => alertTrigger = false)">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            }


            @if (successAlert)
            {
                <div class="alert alert-success alert-dismissible fade show my-3" role="alert">
                    <strong>@alertMessage</strong> @alertBody
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" @onclick="(() => successAlert = false)">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            }
            
            
            <div class="container-fluid">
                
                @if (activeUser.location.Equals("") && LoginService.activeUser.userPrivileges.Contains("XP"))
                {

                    <div class="row mt-3">
                    
                        <div class="col p-3">
                            <div id="accordionStats" style="width: 100%;">

                                <div class="card" style="width: 100%;">
                                    <div class="card-header" id="epkrsstats">
                                        <div class="border border-1">
                                            <button id="epkrsstatstitle" class="btn w-100" data-toggle="collapse" data-target="#epkrsstatsdata" aria-expanded="true" aria-controls="epkrsstatsdata" @onclick="initializeChart">
                                                <b>EPKRS General Statistics</b>
                                            </button>
                                        </div>
                                    </div>

                                    <div id="epkrsstatsdata" class="collapse" aria-labelledby="epkrsstatstitle" data-parent="#accordionStats">
                                        <div class="card-body">

                                            @if (previewGeneralStatistics != null)
                                            {
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover" style="width: 100%;">
                                                        <thead>
                                                            <tr>
                                                                <th class="text-center align-middle text-wrap" style="width: 17%;">Reporting Type</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 17%;">Risk Type</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 8%;">Total Reports</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 8%;">Open Reports</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 8%;">Approved Reports</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 8%;">On Progress Reports</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 8%;">Closed Reports</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 13%;">Report Total Value (Rp.)</th>
                                                                <th class="text-center align-middle text-wrap" style="width: 13%;">Report Return Value (Rp.)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var stat in previewGeneralStatistics)
                                                            {
                                                                <tr>
                                                                    <td class="text-center align-middle text-wrap">
                                                                        @if (EPKRSService.reportingTypes.SingleOrDefault(x => x.ReportingID.Equals(stat.ReportingID)) != null)
                                                                            @(EPKRSService.reportingTypes.SingleOrDefault(x => x.ReportingID.Equals(stat.ReportingID)).ReportingDescription)
                                                                        else
                                                                            @stat.ReportingID
                                                                    </td>
                                                                    <td class="text-center align-middle text-wrap">
                                                                        @if (EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(stat.RiskID)) != null)
                                                                            @(EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(stat.RiskID)).RiskDescription)
                                                                        else
                                                                            @stat.ReportingID
                                                                    </td>
                                                                    <td class="text-center align-middle text-wrap">@stat.ReportTotalDocuments.ToString("N0")</td>
                                                                    <td class="text-center align-middle text-wrap">@stat.ReportTotalOpenDocuments.ToString("N0")</td>
                                                                    <td class="text-center align-middle text-wrap">@stat.ReportTotalApprovedDocuments.ToString("N0")</td>
                                                                    <td class="text-center align-middle text-wrap">@stat.ReportTotalOnProgressDocuments.ToString("N0")</td>
                                                                    <td class="text-center align-middle text-wrap">@stat.ReportTotalClosedDocuments.ToString("N0")</td>
                                                                    <td class="text-center align-middle text-wrap">Rp. @stat.ReportTotalValue.ToString("N0") ,-</td>
                                                                    <td class="text-center align-middle text-wrap">Rp. @stat.ReportReturnValue.ToString("N0") ,-</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                <td class="text-center align-middle text-wrap fw-bold" colspan="2">Grand Total</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">@previewGeneralStatistics.Sum(x => x.ReportTotalDocuments).ToString("N0")</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">@previewGeneralStatistics.Sum(x => x.ReportTotalOpenDocuments).ToString("N0")</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">@previewGeneralStatistics.Sum(x => x.ReportTotalApprovedDocuments).ToString("N0")</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">@previewGeneralStatistics.Sum(x => x.ReportTotalOnProgressDocuments).ToString("N0")</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">@previewGeneralStatistics.Sum(x => x.ReportTotalClosedDocuments).ToString("N0")</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">Rp. @previewGeneralStatistics.Sum(x => x.ReportTotalValue).ToString("N0") ,-</td>
                                                                <td class="text-center align-middle text-wrap fw-bold">Rp. @previewGeneralStatistics.Sum(x => x.ReportReturnValue).ToString("N0") ,-</td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            }

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                
                    <div class="row">

                        <div class="col p-3">
                            <div id="accordionPanel" style="width: 100%;">

                                <div class="card" style="width: 100%;">
                                    <div class="card-header" id="epkrsmpanel">
                                        <div class="border border-1">
                                            <button id="epkrsmpaneltitle" class="btn w-100" data-toggle="collapse" data-target="#epkrsmpaneldata" aria-expanded="true" aria-controls="epkrsmpaneldata" @onclick="initializeChart">
                                                <b>EPKRS Monitoring Panel</b>
                                            </button>
                                        </div>
                                    </div>

                                    <div id="epkrsmpaneldata" class="collapse" aria-labelledby="epkrsmpaneltitle" data-parent="#accordionPanel">
                                        <div class="card-body">

                                            <div class="row">
                                                <div class="col align-middle text-center">
                                                    <canvas id="topLocationReportStats" class="border border-2 p-1 w-100"></canvas>
                                                </div>
                                                <div class="col align-middle text-center">
                                                    <canvas id="itemCategoryStats" class="border border-2 p-1 w-100"></canvas>
                                                </div>
                                            </div>

                                            <div class="row my-2">
                                                <div class="col align-middle text-center">
                                                    <canvas id="itemCaseValueStats" class="border border-2 p-1 w-100"></canvas>
                                                </div>
                                                <div class="col align-middle text-center">
                                                    <canvas id="itemCaseCategoryStats" class="border border-2 p-1 w-100"></canvas>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                }


                <div class="row">
                    <div class="col">
                        <div class="border border-2 my-3 p-2">
                            <h5 class="float-lg-end"><b>Ongoing EPKRS Document</b></h5>
                            <ul class="nav nav-pills flex-column flex-sm-row" id="myTab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="itemcase-tab" data-toggle="tab" href="#itemcase" role="tab" aria-controls="itemcase" aria-selected="true">Item Case &lt; @itemCasePageActive of @itemCaseNumberofPages &gt;</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="incac-tab" data-toggle="tab" href="#incac" role="tab" aria-controls="incac" aria-selected="false">Incident/Accident &lt; @incidentAccidentPageActive of @incidentAccidentNumberofPages &gt;</a>
                                </li>
                            </ul>

                            <div class="tab-content" id="myTabContent">
                                <div class="tab-pane fade show active" id="itemcase" role="tabpanel" aria-labelledby="itemcase-tab">
                                    @if (checkItemCaseData())
                                    {
                                        <div class="m-2 p-1">
                                            @foreach (var itemCase in EPKRSService.itemCases)
                                            {
                                                <div class="card my-1">
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col align-middle my-auto" style="text-align: center;">
                                                                <h5 class="card-title mb-2 text-muted">@itemCase.itemCase.DocumentID</h5>
                                                                <h6 class="card-subtitle">@EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(itemCase.itemCase.RiskID)).RiskDescription</h6>
                                                                <br />
                                                                @if (ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(itemCase.itemCase.SiteReporter)) != null)
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">@ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(itemCase.itemCase.SiteReporter)).locationName</h6>
                                                                }
                                                                else if (itemCase.itemCase.SiteReporter.Equals("HO"))
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">HEAD OFFICE</h6>
                                                                }
                                                                else
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">@itemCase.itemCase.SiteReporter</h6>
                                                                }
                                                            </div>
                                                            <div class="col">
                                                                <p class="card-text">
                                                                    <b> Loading Document No : </b> @itemCase.itemCase.LoadingDocumentID, @itemCase.itemCase.LoadingDocumentDate.ToString("dd / MM / yyyy")
                                                                    <br />
                                                                    <b> Report Date : </b> @itemCase.itemCase.ReportDate.ToString("dd / MM / yyyy")
                                                                    <br />
                                                                    <b> Variance Date : </b> @itemCase.itemCase.VarianceDate
                                                                    <br />
                                                                    <b> Document Status : </b> @itemCase.itemCase.DocumentStatus
                                                                </p>
                                                                <button class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#itemCasePreviewModal" @onclick="(() => setItemCasePreviewData(itemCase))"><i class="oi oi-document"></i> Preview Document</button>
                                                                <button class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#discussionModal" @onclick="(async () => await setDocumentDiscussionPreviewData(itemCase.itemCase.DocumentID, itemCase.itemCase.SiteReporter))"><i class="oi oi-chat"></i> Discussion Panel
                                                                    @{
                                                                        var unreadCountA = EPKRSService.documentDiscussions.ExceptBy(EPKRSService.documentDiscussionReadHistories.Select(f => f.rowGuid), g => g.rowGuid).Where(h => h.DocumentID.Equals(itemCase.itemCase.DocumentID)).ToList().Count;
                                                                    }
                                                                    @if (unreadCountA > 0)
                                                                    {   
                                                                        <span class="badge bg-danger text-white">@unreadCountA.ToString("N0")</span>
                                                                    }
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="fw-bold text-center">. . . There is no Document . . .</p>
                                    }
                                </div>

                                <div class="tab-pane fade" id="incac" role="tabpanel" aria-labelledby="incac-tab">

                                    <form @onsubmit="incidentAccidentFilter">
                                        <div class="input-group my-3">
                                            <div class="input-group-prepend">
                                                <select class="form-select" @bind="incidentAccidentFilterType">
                                                    <option hidden disabled value="">Filter By</option>
                                                    <option value="ID">EPKRS ID</option>
                                                    <option value="LOC">Location</option>
                                                    <option value="STATUS">Status</option>
                                                </select>
                                            </div>
                                            <input type="text" class="form-control" aria-label="Text input with dropdown button" @bind-value="incidentAccidentFilterValue">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary fw-bold" type="button" disabled="@(incidentAccidentFilterActive ? null : "disabled")" @onclick="resetIncidentAccidentFilter">Reset</button>
                                            </div>
                                        </div>
                                        <input type="submit" hidden>
                                    </form>
                                    
                                    @if (checkIncidentAccidentData())
                                    {
                                        <div class="m-2 p-1">
                                            @foreach (var incidentAccident in EPKRSService.incidentAccidents)
                                            {
                                                <div class="card my-1">
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col align-middle my-auto" style="text-align: center;">
                                                                <h5 class="card-title mb-2 text-muted">@incidentAccident.incidentAccident.DocumentID</h5>
                                                                <h6 class="card-subtitle">@EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(incidentAccident.incidentAccident.RiskID)).RiskDescription</h6>
                                                                <br />
                                                                @if (ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(incidentAccident.incidentAccident.SiteReporter)) != null)
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">@ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(incidentAccident.incidentAccident.SiteReporter)).locationName</h6>
                                                                }
                                                                else if (incidentAccident.incidentAccident.SiteReporter.Equals("HO"))
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">HEAD OFFICE</h6>
                                                                }
                                                                else
                                                                {
                                                                    <h6 class="card-subtitle mb-2 text-muted">@incidentAccident.incidentAccident.SiteReporter</h6>
                                                                }
                                                            </div>
                                                            <div class="col">
                                                                <p class="card-text">
                                                                    <b> Case Description : </b> @incidentAccident.incidentAccident.CaseDescription
                                                                    <br />
                                                                    <b> Report Date : </b> @incidentAccident.incidentAccident.ReportDate.ToString("dd / MM / yyyy")
                                                                    <br />
                                                                    <b> PIC : </b> @incidentAccident.incidentAccident.PIC
                                                                    <br />
                                                                    <b> Document Status : </b> @incidentAccident.incidentAccident.DocumentStatus
                                                                </p>
                                                                <button class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#incidentAccidentPreviewModal" @onclick="(() => setIncidentAccidentPreviewData(incidentAccident))"><i class="oi oi-document"></i> Preview Document</button>
                                                                <button class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#discussionModal" @onclick="(async () => await setDocumentDiscussionPreviewData(incidentAccident.incidentAccident.DocumentID, incidentAccident.incidentAccident.SiteReporter))"><i class="oi oi-chat"></i> Discussion Panel
                                                                    @{
                                                                        var unreadCountB = EPKRSService.documentDiscussions.ExceptBy(EPKRSService.documentDiscussionReadHistories.Select(f => f.rowGuid), g => g.rowGuid).Where(h => h.DocumentID.Equals(incidentAccident.incidentAccident.DocumentID)).ToList().Count;
                                                                    }
                                                                    @if (unreadCountB > 0)
                                                                    {
                                                                        <span class="badge bg-danger text-white">@unreadCountB.ToString("N0")</span>
                                                                    }
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }

                                            <nav aria-label="Incident Accident Pagination">
                                                <ul class="pagination pagination-sm justify-content-center my-2">
                                                    @if ((incidentAccidentPageActive - 1) > 0)
                                                    {
                                                        <li class="page-item px-1 paging-style" @onclick="(() => incidentAccidentPageSelect((incidentAccidentPageActive - 1)))"><span class="page-link">Previous</span></li>
                                                        <li class="page-item paging-style" @onclick="(() => incidentAccidentPageSelect((incidentAccidentPageActive - 1)))"><span class="page-link">@(incidentAccidentPageActive - 1)</span></li>
                                                    }
                                                    else
                                                    {
                                                        <li class="page-item px-1 disabled dis-paging-style"><span class="page-link">Previous</span></li>
                                                        <li class="page-item disabled dis-paging-style"><span class="page-link">. . .</span></li>
                                                    }

                                                    <li class="page-item active dis-paging-style"><span class="page-link">@incidentAccidentPageActive</span></li>

                                                    @if (incidentAccidentPageActive < incidentAccidentNumberofPages)
                                                    {
                                                        <li class="page-item paging-style" @onclick="(() => incidentAccidentPageSelect((incidentAccidentPageActive + 1)))"><span class="page-link">@(incidentAccidentPageActive + 1)</span></li>
                                                        <li class="page-item px-1 paging-style" @onclick="(() => incidentAccidentPageSelect((incidentAccidentPageActive + 1)))"><span class="page-link">Next</span></li>
                                                    }
                                                    else
                                                    {
                                                        <li class="page-item disabled dis-paging-style"><span class="page-link">. . .</span></li>
                                                        <li class="page-item px-1 disabled dis-paging-style"><span class="page-link">Next</span></li>
                                                    }
                                                </ul>
                                            </nav>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="fw-bold text-center">. . . There is no Document . . .</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        }   
    }
    else
    {
        <div class="container-fluid">
            <div class="row">
                <div class="col align-middle text-center">
                    <h3>Fetch Data Privileges in Process</h3>
                    <small>Refresh Page Using Button Below If There is No Response</small>
                    <br />
                    <button type="button" class="btn btn-primary my-4" @onclick="(() => StateHasChanged())"><b>Refresh Page</b></button>
                </div>
            </div>
        </div>
    }
}

@if (isLoading)
{
    <div class="modal show" id="splashLoading" tabindex="-5" role="dialog" aria-labelledby="splashLoadingDialog" aria-hidden="true" style="display:block; background: rgba(0,0,0, 0.7);">
        <BPIWebApplication.Client.Shared.CustomLayout.SplashScreen></BPIWebApplication.Client.Shared.CustomLayout.SplashScreen>
    </div>
}

@*Item Case Document Preview Modal*@
<div class="modal fade" id="itemCasePreviewModal" tabindex="-1" role="dialog" aria-labelledby="itemCasePreviewLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header cus-bg">
                <h5 class="modal-title fw-bold" id="itemCasePreviewLabel"><i class="oi oi-document"></i> Item Case Document Preview</h5>
                <button type="button" class="close" data-dismiss="modal" data-target="#incidentAccidentPreviewModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col fw-bold">Document ID</div>
                    <div class="col">: @previewItemCase.DocumentID</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Report Date</div>
                    <div class="col">: @previewItemCase.ReportDate.ToString("dd MMMM yyyy")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Site Reporter</div>
                    <div class="col">: @(ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(previewItemCase.SiteReporter)) == null ? previewItemCase.SiteReporter.Equals("HO") ? "HEAD OFFICE" : previewItemCase.SiteReporter : ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(previewItemCase.SiteReporter)).locationName)</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Site Sender</div>
                    <div class="col">: @(ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(previewItemCase.SiteSender)) == null ? previewItemCase.SiteReporter.Equals("HO") ? "HEAD OFFICE" : previewItemCase.SiteReporter : ManagementService.locations.SingleOrDefault(x => x.locationId.Equals(previewItemCase.SiteSender)).locationName)</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Loading Document ID</div>
                    <div class="col">: @previewItemCase.LoadingDocumentID</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Loading Document Date</div>
                    <div class="col">: @previewItemCase.LoadingDocumentDate.ToString("dd MMMM yyyy")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Item Pickup Date</div>
                    <div class="col">: @previewItemCase.ItemPickupDate.ToString("dd MMMM yyyy")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Late Status</div>
                    <div class="col">: @(previewItemCase.isLate.Equals(true) ? "Late" : "On Time")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Variance</div>
                    <div class="col">: @previewItemCase.VarianceDate Day(s)</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">CCTV Status</div>
                    <div class="col">: @(previewItemCase.isCCTVCoverable.Equals(true) ? "Covered" : "Not Covered") </div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Report Sender Status</div>
                    <div class="col">: @(previewItemCase.isReportedtoSender.Equals(true) ? "Reported" : "Not Reported")</div>
                </div>

                @if (previewItemCase.DocumentStatus.Equals("OnProgress") || previewItemCase.DocumentStatus.Equals("Closed"))
                {
                    <div class="row">
                        <div class="col fw-bold">RISK Mitigation Plan</div>
                        <div class="col">: @previewItemCase.ExtendedMitigationPlan</div>
                    </div>
                }

                <div class="row my-3">
                    <div class="col">
                        <p class="fw-bold"><i class="oi oi-paperclip"></i> Attachment </p>

                        @if (checkPreviewCaseAttachment())
                        {
                            <div class="row flex-row flex-nowrap wrap-card overflow-auto">
                                @foreach (var file in previewCaseAttachment)
                                {
                                    @if (EPKRSService.fileStreams.SingleOrDefault(x => x.fileName.Equals(file.FilePath)) == null)
                                        continue;

                                    <div style="width: 280px;">
                                        <div class="card" id="balanceCard" @onclick="@(async () => { await HandleViewDocument(EPKRSService.fileStreams.SingleOrDefault(x => x.fileName.Equals(file.FilePath)).content, file.FilePath.Split("!_!")[1]); })">
                                            <div class="card-body">
                                                <h6 class="card-title text-wrap text-truncate"><b> @file.FilePath.Split("!_!")[1] </b></h6>
                                            </div>
                                            <div class="card-footer">
                                                <small class="text-muted"><i> #@file.LineNum - Click To View File</i></small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning alert-dismissible fade show my-2" role="alert">
                                <strong>Empty Attachment !</strong>
                            </div>
                        }
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        @if (checkPreviewItemLine())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" style="width: 100%">
                                    <caption>
                                        @*Total @previewItemLine.Count() Item(s) in Report*@
                                    </caption>
                                    <thead>
                                        <tr>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 17%; font-size: 15px;">TR ID</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 11%; font-size: 15px;">TR Date</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 11%; font-size: 15px;">Item Code</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 21%; font-size: 15px;">Item Desc.</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 11%; font-size: 15px;">Risk Type</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 5%; font-size: 15px;">Qty</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 5%; font-size: 15px;">UOM</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 14%; font-size: 15px;">Value</th>
                                            <th scope="col" class="text-center align-middle text-wrap" style="width: 5%; font-size: 15px;">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in previewItemLine)
                                        {
                                            <tr>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.TRID</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.TRDate.ToString("dd/MM/yyyy")</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.ItemCode</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.ItemDescription</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.ItemRiskCategoryID</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.ItemQuantity</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.UOM</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">Rp. @item.ItemValue.ToString("N0") ,-</td>
                                                <td class="text-center align-middle text-wrap" style="font-size:14px;">@item.ItemStock</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer cus-bg">
                @if (LoginService.activeUser.userPrivileges.Contains("AP"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#approvalModal" @onclick="@(() => setDocumentApprovalData("Approve"))" disabled="@(previewItemCase.DocumentStatus.Equals("Open") ? null : "disabled")"><i class="oi oi-task"></i> Approve Report</button>
                    <button type="button" class="btn btn-dark mt-1 fw-bold" data-dismiss="modal" data-target="#itemCasePreviewModal" @onclick="@(() => redirectDocumentEdit("ITEMC"))" disabled="@(previewItemCase.DocumentStatus.Equals("Open") ? null : "disabled")"><i class="oi oi-pencil"></i> Edit</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("CF"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#onprogressModal" @onclick="@(() => setDocumentApprovalData("OnProgress"))" disabled="@(previewItemCase.DocumentStatus.Equals("Approved") ? null : "disabled")"><i class="oi oi-flag"></i> Report On Progress</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("RL"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#approvalModal" @onclick="@(() => setDocumentApprovalData("Close"))"><i class="oi oi-lock-locked" disabled="@(previewItemCase.DocumentStatus.Equals("OnProgress") ? null : "disabled")"></i> Close Report</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("ED"))
                {
                    <button type="button" class="btn btn-dark mt-1 fw-bold" data-dismiss="modal" data-target="#itemCasePreviewModal" @onclick="@(() => redirectDocumentEdit("ITEMC"))"><i class="oi oi-pencil"></i> Edit</button>
                }
                <button type="button" class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#discussionModal"><i class="oi oi-chat"></i> Discussion Panel 
                    @{
                        var unreadCountC = EPKRSService.documentDiscussions.ExceptBy(EPKRSService.documentDiscussionReadHistories.Select(f => f.rowGuid), g => g.rowGuid).Where(h => h.DocumentID.Equals(previewItemCase.DocumentID)).ToList().Count;
                    }
                    @if (unreadCountC > 0)
                    {
                        <span class="badge bg-danger text-white">@unreadCountC.ToString("N0")</span>
                    }
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" data-target="#itemCasePreviewModal"><i class="oi oi-x"></i> Close</button>
            </div>
        </div>
    </div>
</div>

@*Incident Accident Document Preview Modal*@
<div class="modal fade" id="incidentAccidentPreviewModal" tabindex="-1" role="dialog" aria-labelledby="incidentAccidentPreviewLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header cus-bg">
                <h5 class="modal-title fw-bold" id="incidentAccidentPreviewLabel"><i class="oi oi-document"></i> Incident Accident Document Preview</h5>
                <button type="button" class="close" data-dismiss="modal" data-target="#incidentAccidentPreviewModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="border border-2 p-2">
                    <div class="row">
                        <div class="col align-middle text-center">
                            <h5 class="fw-bold my-auto"> @previewIncidentAccident.DocumentID </h5>
                            <p class="my-auto"><small> Report Date : @previewIncidentAccident.ReportDate.ToString("dddd, dd MMMM yyyy") </small></p>
                            <p class="my-auto"><b> Document Status </b> - <em> @previewIncidentAccident.DocumentStatus </em></p>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col fw-bold">Site Reporter</div>
                    <div class="col">: @previewIncidentAccident.SiteReporter</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Department Reporter</div>
                    <div class="col">: @((ManagementService.departments.SingleOrDefault(x => x.DepartmentID.Equals(previewIncidentAccident.DepartmentReporter)) == null) ? previewIncidentAccident.DepartmentReporter : ManagementService.departments.SingleOrDefault(x => x.DepartmentID.Equals(previewIncidentAccident.DepartmentReporter)).DepartmentName)  </div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Risk RP</div>
                    <div class="col">: @previewIncidentAccident.RiskRPName - <em> @previewIncidentAccident.RiskRPEmail </em></div>
                </div>
                <div class="row mb-4">
                    <div class="col fw-bold">DORM</div>
                    <div class="col">: @previewIncidentAccident.DORMName - <em> @previewIncidentAccident.DORMEmail </em></div>
                </div>

                @*split*@

                <div class="row mt-4">
                    <div class="col fw-bold">Case Description</div>
                    <div class="col">: @previewIncidentAccident.CaseDescription</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Occurence Date</div>
                    <div class="col">: @previewIncidentAccident.OccurenceDate.ToString("dddd, dd MMMM yyyy")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Department Affected</div>
                    <div class="col">: @((ManagementService.departments.SingleOrDefault(x => x.DepartmentID.Equals(previewIncidentAccident.DepartmentAffected)) == null) ? previewIncidentAccident.DepartmentAffected : ManagementService.departments.SingleOrDefault(x => x.DepartmentID.Equals(previewIncidentAccident.DepartmentAffected)).DepartmentName) </div>
                </div>
                <div class="row mb-4">
                    <div class="col fw-bold">Risk Type</div>
                    <div class="col">: @((EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(previewIncidentAccident.RiskID)) == null) ? "NaN" : EPKRSService.riskTypes.SingleOrDefault(x => x.RiskID.Equals(previewIncidentAccident.RiskID)).RiskDescription)</div>
                </div>

                @*split*@

                <div class="row mt-4">
                    <div class="col fw-bold">Cronology</div>
                    <div class="col text-wrap">: @previewIncidentAccident.Cronology</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Root Cause</div>
                    <div class="col text-wrap">: @previewIncidentAccident.RootCause</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Loss Description</div>
                    <div class="col text-wrap">: @previewIncidentAccident.LossDescription</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Loss Estimation</div>
                    <div class="col">: Rp. @previewIncidentAccident.LossEstimation.ToString("N0") ,-</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Return Amount</div>
                    <div class="col">: Rp. @previewIncidentAccident.ReturnAmount.ToString("N0") ,-</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Risk Description</div>
                    <div class="col text-wrap">: @previewIncidentAccident.RiskDescription</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Cause Description</div>
                    <div class="col text-wrap">: @previewIncidentAccident.CauseDescription</div>
                </div>
                <div class="row mb-4">
                    <div class="col fw-bold">Action Plan</div>
                    <div class="col text-wrap">: @previewIncidentAccident.ActionPlan</div>
                </div>

                @*split*@

                <div class="row mt-4">
                    <div class="col fw-bold">PIC</div>
                    <div class="col">: @previewIncidentAccident.PIC</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Target Date</div>
                    <div class="col">: @previewIncidentAccident.TargetDate.ToString("dddd, dd MMMM yyyy")</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Mitigation Plan</div>
                    <div class="col text-wrap">: @previewIncidentAccident.MitigationPlan</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Mitigation Date</div>
                    <div class="col">: @previewIncidentAccident.MitigationDate.ToString("dddd, dd MMMM yyyy")</div>
                </div>

                @if (previewIncidentAccident.DocumentStatus.Equals("OnProgress") || previewIncidentAccident.DocumentStatus.Equals("Closed"))
                {
                    <div class="row mt-4">
                        <div class="col fw-bold">RISK Root Cause</div>
                        <div class="col">: @previewIncidentAccident.ExtendedRootCause</div>
                    </div>
                    <div class="row">
                        <div class="col fw-bold">RISK Mitigation Plan</div>
                        <div class="col">: @previewIncidentAccident.ExtendedMitigationPlan</div>
                    </div>
                }
                
                <div class="row my-3">
                    <div class="col">
                        <p class="fw-bold text-center"><i class="oi oi-paperclip"></i> Attachment(s) </p>

                        @if (checkPreviewCaseAttachment())
                        {
                            <div class="row flex-row flex-nowrap wrap-card overflow-auto">
                                @foreach (var file in previewCaseAttachment)
                                {
                                    @if (EPKRSService.fileStreams.SingleOrDefault(x => x.fileName.Equals(file.FilePath)) == null)
                                        continue;

                                    <div style="width: 280px;">
                                        <div class="card" id="balanceCard" @onclick="@(async () => { await HandleViewDocument(EPKRSService.fileStreams.SingleOrDefault(x => x.fileName.Equals(file.FilePath)).content, file.FilePath.Split("!_!")[1]); })">
                                            <div class="card-body">
                                                <h6 class="card-title text-wrap text-truncate"><b> @file.FilePath.Split("!_!")[1] </b></h6>
                                            </div>
                                            <div class="card-footer">
                                                <small class="text-muted"><i> #@file.LineNum - Click To View File</i></small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning alert-dismissible fade show my-2" role="alert">
                                <strong>Empty Attachment !</strong>
                            </div>
                        }
                    </div>
                </div>

            </div>
            <div class="modal-footer cus-bg">
                @if (LoginService.activeUser.userPrivileges.Contains("AP"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#approvalModal" @onclick="@(() => setDocumentApprovalData("Approve"))" disabled="@(previewIncidentAccident.DocumentStatus.Equals("Open") ? null : "disabled")"><i class="oi oi-task"></i> Approve Report</button>
                    <button type="button" class="btn btn-dark mt-1 fw-bold" data-dismiss="modal" data-target="#incidentAccidentPreviewModal" @onclick="@(() => redirectDocumentEdit("INCAC"))" disabled="@(previewIncidentAccident.DocumentStatus.Equals("Open") ? null : "disabled")"><i class="oi oi-pencil"></i> Edit</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("CF"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#onprogressModal" @onclick="@(() => setDocumentApprovalData("OnProgress"))" disabled="@(previewIncidentAccident.DocumentStatus.Equals("Approved") ? null : "disabled")"><i class="oi oi-flag"></i> Report On Progress</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("RL"))
                {
                    <button type="button" class="btn btn-warning mt-1 fw-bold" data-toggle="modal" data-target="#approvalModal" @onclick="@(() => setDocumentApprovalData("Close"))" disabled="@(previewIncidentAccident.DocumentStatus.Equals("OnProgress") ? null : "disabled")"><i class="oi oi-lock-locked"></i> Close Report</button>
                }
                @if (LoginService.activeUser.userPrivileges.Contains("ED"))
                {
                    <button type="button" class="btn btn-dark mt-1 fw-bold" data-dismiss="modal" data-target="#incidentAccidentPreviewModal" @onclick="@(() => redirectDocumentEdit("INCAC"))"><i class="oi oi-pencil"></i> Edit</button>
                }
                <button type="button" class="btn btn-primary-cus mt-1" data-toggle="modal" data-target="#discussionModal" @onclick="(async () => await setDocumentDiscussionPreviewData(previewIncidentAccident.DocumentID, previewIncidentAccident.SiteReporter))"><i class="oi oi-chat"></i> Discussion Panel 
                    @{
                        var unreadCountD = EPKRSService.documentDiscussions.ExceptBy(EPKRSService.documentDiscussionReadHistories.Select(f => f.rowGuid), g => g.rowGuid).Where(h => h.DocumentID.Equals(previewIncidentAccident.DocumentID)).ToList().Count;
                    }
                    @if (unreadCountD > 0) 
                    {
                        <span class="badge bg-danger text-white">@unreadCountD.ToString("N0")</span>
                    }
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" data-target="#incidentAccidentPreviewModal"><i class="oi oi-x"></i> Close</button>
            </div>
        </div>
    </div>
</div>

@*Document Discussion Modal*@
<div class="modal fade" id="discussionModal" tabindex="-2" role="dialog" aria-labelledby="discussionModalLabel" aria-hidden="true" style="background: rgba(0,0,0, 0.2);">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header cus-bg">
                <h5 class="modal-title fw-bold" id="discussionModalLabel"><i class="oi oi-chat"></i> Document Discussion</h5>
                <button type="button" class="close" data-dismiss="modal" data-target="#discussionModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                @if (LoginService.activeUser.userPrivileges.Contains("CR"))
                {
                    <div class="card">
                        <div class="card-header">
                            Let&quot;s Start a New Discussion
                        </div>
                        <div class="card-body">
                            <EditForm Model="@uploadDocumentDiscussion" OnSubmit="createDocumentDiscussion">
                                <InputTextArea id="cronology" @bind-Value="uploadDocumentDiscussion.Comment" placeholder="Write a Comment .." class="form-control mb-3" readonly="@(isLoading || triggerReplyButton ? "readonly" : null)"></InputTextArea>

                                @if (checkFileDiscussUpload())
                                {
                                    <ul class="list-group mb-3">
                                        @foreach (var attachedFile in fileDiscussionUpload)
                                        {
                                            <li class="list-group-item">@attachedFile.fileName.Split("!_!")[1]</li>
                                        }
                                    </ul>
                                }

                                <label for="discussionUploadFile" class="btn btn-primary-cus @(triggerReplyButton.Equals(false) ? null : "disabled")"><i class="oi oi-paperclip"></i> Attach</label>
                                <InputFile id="discussionUploadFile" accept=".pdf" multiple hidden disabled="@(isLoading || triggerReplyButton ? "disabled" : null)" OnChange="@((InputFileChangeEventArgs args) => UploadHandleSelection(args, "New"))"></InputFile>
                                <button type="submit" class="btn btn-primary-cus" disabled="@(isLoading || triggerReplyButton ? "disabled" : null)"><i class="oi oi-chat"></i> Comment</button>
                            </EditForm>
                        </div>
                    </div>
                }
                
                @if (checkDocumentDiscussions())
                {
                    @foreach (var discussion in previewDocumentDiscussion.OrderByDescending(x => x.CommentDate))
                    {
                        @if (!discussion.ReplyRowGuid.Equals(""))
                            continue;

                        <div class="card mt-2">
                            <div class="card-header">
                                <b> Topic #@discussion.rowGuid.Split("-")[0] </b>
                            </div>
                            <div class="card-body">
                                <blockquote class="blockquote mb-0">
                                    <p>@discussion.Comment</p>
                                    <footer class="blockquote-footer">Commented by @discussion.UserName on @discussion.CommentDate.ToString("dddd, dd MMMM yyyy HH:mm:ss")</footer>
                                </blockquote>

                                @if (LoginService.activeUser.userPrivileges.Contains("CR"))
                                {
                                    @if (!triggerReplyButton)
                                    {
                                        <p class="mb-0 mt-3">
                                            <button class="btn btn-primary-cus" type="button" disabled="@(isLoading ? "disabled" : null)" @onclick="(() => triggerReplyButton = !triggerReplyButton)" data-toggle="collapse" data-target="#@discussion.formId" aria-expanded="false" aria-controls="@discussion.formId">
                                                <i class="oi oi-chat"></i> Reply
                                            </button>
                                        </p>
                                    }

                                    <div class="collapse" id="@discussion.formId">
                                        <div class="card card-body">
                                            <EditForm Model="@uploadReplyDocumentDiscussion" OnSubmit="(() => replyDiscussion(discussion))">
                                                <InputTextArea id="cronology" @bind-Value="uploadReplyDocumentDiscussion.Comment" placeholder="Write a Comment .." class="form-control mb-3" readonly="@(isLoading || !triggerReplyButton ? "readonly" : null)"></InputTextArea>

                                                @if (checkReplyFileDiscussUpload())
                                                {
                                                    <ul class="list-group mb-3">
                                                        @foreach (var attachedFile in fileReplyDiscussionUpload)
                                                        {
                                                            <li class="list-group-item">@attachedFile.fileName.Split("!_!")[1]</li>
                                                        }
                                                    </ul>
                                                }

                                                <button class="btn btn-secondary" type="button" disabled="@(isLoading ? "disabled" : null)" @onclick="(() => triggerReplyButton = !triggerReplyButton)" data-toggle="collapse" data-target="#@discussion.formId" aria-expanded="false" aria-controls="@discussion.formId">
                                                    <i class="oi oi-collapse-up"></i> Hide
                                                </button>
                                                <label for="discussionReplyUploadFile" class="btn btn-primary-cus @(triggerReplyButton.Equals(false) ? "disabled" : null)"><i class="oi oi-paperclip"></i> Reply Attach</label>
                                                <InputFile id="discussionReplyUploadFile" accept=".pdf" multiple hidden disabled="@(isLoading || !triggerReplyButton ? "disabled" : null)" OnChange="@((InputFileChangeEventArgs args) => UploadHandleSelection(args, "Reply"))"></InputFile>
                                                <button type="submit" class="btn btn-primary-cus" disabled="@(isLoading || !triggerReplyButton ? "disabled" : null)"><i class="oi oi-chat"></i> Reply Comment</button>
                                            </EditForm>
                                        </div>
                                    </div>
                                }

                                @if (previewDocumentDiscussion.Any(x => x.ReplyRowGuid.Equals(discussion.rowGuid)))
                                {
                                    @foreach (var reply in previewDocumentDiscussion.Where(x => x.ReplyRowGuid.Equals(discussion.rowGuid)).OrderByDescending(x => x.CommentDate))
                                    {
                                        <div class="card mt-2">
                                            <div class="card-body">
                                                <blockquote class="blockquote mb-0">
                                                    <p>@reply.Comment</p>
                                                    <footer class="blockquote-footer">Replied by @reply.UserName on @reply.CommentDate.ToString("dddd, dd MMMM yyyy HH:mm:ss")</footer>
                                                </blockquote>
                                            </div>
                                        </div>                                        
                                    }
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning alert-dismissible fade show my-2" role="alert">
                        <strong>Empty Discussion !</strong>
                    </div>
                }
            </div>
            <div class="modal-footer cus-bg">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" data-target="#discussionModal"><i class="oi oi-x"></i> Close</button>
            </div>
        </div>
    </div>
</div>

@*Document Approve Modal*@
<div class="modal fade" id="approvalModal" tabindex="-3" role="dialog" aria-labelledby="approvalModalLabel" aria-hidden="true" style="background: rgba(0,0,0, 0.2);">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header cus-bg">
                <h5 class="modal-title fw-bold" id="approvalModalLabel"><i class="oi oi-pin"></i> Document Approval</h5>
                <button type="button" class="close" data-dismiss="modal" data-target="#approvalModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col fw-bold text-wrap">Process PKRS Document as follow below, Are you sure ?</div>
                </div>
                <div class="row mt-4">
                    <div class="col fw-bold">Document ID</div>
                    <div class="col">: @previewDocumentApproval.DocumentID</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Approval Action</div>
                    <div class="col">: @previewDocumentApproval.ApprovalAction</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">User</div>
                    <div class="col">: @previewDocumentApproval.Approver</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Action Date</div>
                    <div class="col">: @previewDocumentApproval.ApproveDate.ToString("dddd, dd MMMM yyyy")</div>
                </div>
            </div>
            <div class="modal-footer cus-bg">
                <button type="button" class="btn btn-success fw-bold"
                    disabled="@(EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)).itemCase.DocumentStatus.Equals("Open") ? null : "disabled" :
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)).incidentAccident.DocumentStatus.Equals("Open") ? null : "disabled" :
                                "disabled")"
                    @onclick="@(() => createDocumentApprove("Approve"))"><i class="oi oi-thumb-up"></i> Approve !</button>
                <button type="button" class="btn btn-danger fw-bold"
                        disabled="@(EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)).itemCase.DocumentStatus.Equals("OnProgress") ? null : "disabled" :
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)).incidentAccident.DocumentStatus.Equals("OnProgress") ? null : "disabled" :
                                "disabled")"
                        @onclick="@(() => createDocumentApprove("Close"))"><i class="oi oi-thumb-up"></i> Close !</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" data-target="#approvalModal"><i class="oi oi-thumb-down"></i> Cancel</button>
            </div>
        </div>
    </div>
</div>

@*Document Onprogress Modal*@
<div class="modal fade" id="onprogressModal" tabindex="-3" role="dialog" aria-labelledby="onprogressModalLabel" aria-hidden="true" style="background: rgba(0,0,0, 0.2);">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header cus-bg">
                <h5 class="modal-title fw-bold" id="onprogressModalLabel"><i class="oi oi-pin"></i> Mark Document as On Progress</h5>
                <button type="button" class="close" data-dismiss="modal" data-target="#onprogressModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col fw-bold text-wrap">Process PKRS Document Status as On Progress, Are you sure ?</div>
                </div>
                <div class="row mt-4">
                    <div class="col fw-bold">Document ID</div>
                    <div class="col">: @previewDocumentApproval.DocumentID</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Approval Action</div>
                    <div class="col">: @previewDocumentApproval.ApprovalAction</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">User</div>
                    <div class="col">: @previewDocumentApproval.Approver</div>
                </div>
                <div class="row">
                    <div class="col fw-bold">Action Date</div>
                    <div class="col">: @previewDocumentApproval.ApproveDate.ToString("dddd, dd MMMM yyyy")</div>
                </div>
                
                @if (EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null)
                {
                    <EditForm Model="@updateItemCase" class="my-3">
                        <div class="row">
                            <div class="col">
                                <label for="ext_mitigation">RISK Mitigation Plan :</label>
                                <InputTextArea id="ext_mitigation" @bind-Value="updateItemCase.ExtendedMitigationPlan" class="form-control" disabled="@(updateItemCase.DocumentStatus.Equals("Closed") ? "disabled" : null)"></InputTextArea>
                            </div>
                        </div>
                    </EditForm>
                }

                @if (EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null)
                {
                    <EditForm Model="@updateIncidentAccident" class="my-3">
                        <div class="row">
                            <div class="col">
                                <label for="ext_rootcause">RISK Root Cause :</label>
                                <InputTextArea id="ext_rootcause" @bind-Value="updateIncidentAccident.ExtendedRootCause" class="form-control" disabled="@(updateIncidentAccident.DocumentStatus.Equals("Closed") ? "disabled" : null)"></InputTextArea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label for="ext_mitigation">RISK Mitigation Plan :</label>
                                <InputTextArea id="ext_mitigation" @bind-Value="updateIncidentAccident.ExtendedMitigationPlan" class="form-control" disabled="@(updateIncidentAccident.DocumentStatus.Equals("Closed") ? "disabled" : null)"></InputTextArea>
                            </div>
                        </div>
                    </EditForm>
                }

            </div>
            <div class="modal-footer cus-bg">
                <button type="button" class="btn btn-success fw-bold"
                        disabled="@(EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.itemCases.SingleOrDefault(x => x.itemCase.DocumentID.Equals(previewDocumentApproval.DocumentID)).itemCase.DocumentStatus.Equals("Approved") ? null : "disabled" :
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)) != null ?
                                EPKRSService.incidentAccidents.SingleOrDefault(x => x.incidentAccident.DocumentID.Equals(previewDocumentApproval.DocumentID)).incidentAccident.DocumentStatus.Equals("Approved") ? null : "disabled" :
                                "disabled")"
                        @onclick="@(() => createDocumentApproveExtended("OnProgress"))">
                    <i class="oi oi-thumb-up"></i> On Progress !
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" data-target="#onprogressModal"><i class="oi oi-thumb-down"></i> Cancel</button>
            </div>
        </div>
    </div>
</div>